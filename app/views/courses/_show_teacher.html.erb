<div class="row flex--freeze">
  <div class="col-9">
    <header class="dashboard__header">
      <h1>
        <%= course.title %>
        <%= link_to edit_course_path(course), class: "btn--icon btn--settings" do %>
          수업 수정하기
        <% end %>
      </h1>
    </header>
  </div>

  <div class="col-3">
    <button type="button"
      class="btn--default btn--large"
      id="btn-add-student">
      수강생 추가하기
    </a>
  </div>

  <div class="col-12 mt-24">
    <div class="dashboard__header__detail">
      <dl>
        <dt>분야</dt>
        <dd>
          <%= course.course_category_str %>
        </dd>
      </dl>

      <dl>
        <dt>학점</dt>
        <dd>
          <%= course.course_credit_str %>
        </dd>
      </dl>

      <dl>
        <dt>레벨</dt>
        <dd>
          <%= course.course_level_str %>
        </dd>
      </dl>

      <dl>
        <dt>수강인원</dt>
        <dd>
          <%= @enrolled_students.count %> / <%= course.capacity %>
        </dd>
      </dl>


      <dl>
        <dt>목표</dt>
        <dd>
          <%= course.description %>
        </dd>
      </dl>
    </div>
  </div>
</div>

<div class="row"
  style="flex-grow: 1">

  <div class="col-lg-9 height--max"
    id="enrolled-students">

    <section class="dashboard-section height--max">
      <header class="dashboard-section__header">
        <h1>
          수강생 대시보드
          <span>
            <%= @enrolled_students.count %>
          </span>
        </h1>
      </header>

      <div class="dashboard__content height--max pb-32"
        style="flex-grow: 1">
        <% if @enrolled_students.empty? %>
          <p class="ui--secondary pt-40 text-center">
            수강생이 없습니다.
          </p>
        <% else %>

          <ul class="user__list">
            <% @enrolled_students.each do |stu| %>

              <li class="user__item">

                <article class="user">

                  <header class="user__header">
                    <% if stu.profile.url %>
                      <p class="user__img"
                        aria-hidden="true">
                        <%= image_tag stu.profile.url %>
                      </p>
                    <% else %>
                      <p class="user__img--placeholder"
                        aria-hidden="true">
                        <%= stu.name[0] %>
                      </p>
                    <% end %>

                    <h1>
                      <%= stu.name %>
                    </h1>
                    <p class="ui--secondary">
                      서강대학교 / <%= stu.user_department_str %>
                    </p>
                  </header>

                  <section class="user__content">
                    <ul class="user__assignments">

                      <% course.requirements.each do |r| %>
                        <%= render partial: "assignment", locals: { stu: stu, r: r } %>
                      <% end %>

                    </ul>

                    <footer>
                      <%= link_to '수강생 삭제', minus_student_course_user_path(course.id, stu.id), class: "ui--accent" %>
                    </footer>
                  </section>
                </article>


              </li>
            <% end %>

          </ul>
        <% end %>
      </div>
    </section>

  </div>

  <div class="col-lg-3 height--max">
    <section class="dashboard-section height--max"
      id="panel">

      <header class="dashboard-section__header">
        <h1>
          수강생 추가하기
          <span>
            <%= students.count %>
          </span>
        </h1>
      </header>

      <div class="dashboard__content">

          <% if students.count == 0 %>

            <p class="ui--secondary pt-16 pb-16 text-center">
              추가 가능한 학생이 없습니다.
            </p>

          <% else %>

            <ul class="panel__list">

              <% students.each do |stu| %>

                <li class="panel__item">
                  <%= link_to add_student_course_user_path(course.id, stu.id) do %>
                    <%= render partial: "panel_item", locals: { stu: stu } %>
                  <% end %>
                </li>

              <% end %>

            </ul>

          <% end %>
          
      </div>
    </section>
  </div>

</div>


<script>
  (function() {
    var addStudent = document.getElementById("btn-add-student");
    var panel = document.getElementById("panel");
    var userItems = document.querySelectorAll("#enrolled-students .user__header");
    var activeUserItem = null;

    Array.prototype.slice.call(userItems);

    addStudent.addEventListener("click", togglePanel)
    
    userItems.forEach(function(item) {
      item.addEventListener("click", function() {
        console.log("item:", item)
        toggleListItem(this, "active")
      });
    })

    function togglePanel () {
      Panel.classList.toggle("active")
    }

    function toggleListItem (elm, classname) {
      var parentNode = elm.parentNode;
      var parentNodeClassList = parentNode.classList;

      parentNodeClassList.toggle(classname);

      console.log("activeUserItem:", activeUserItem)
      if (activeUserItem == null) activeUserItem = elm;
      else if (activeUserItem === elm) activeUserItem = null;
      else {
        console.log("why activeUserItem:", activeUserItem);
        console.log("why activeUserItem parent:", activeUserItem.parentNode);

        activeUserItem.parentNode.classList.toggle(classname);
        activeUserItem = elm;
      }
    }

  })()
</script>
